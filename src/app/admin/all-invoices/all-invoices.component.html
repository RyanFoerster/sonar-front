<div class="mx-4 sm:mx-10">
  <h1 class="text-2xl font-bold mb-6">Toutes les Factures</h1>

  <!-- Filtres et Recherche -->
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200"
  >
    <!-- Filtre par Statut -->
    <div class="w-full md:w-auto flex-shrink-0">
      <label
        class="block text-sm font-medium text-gray-700 mb-1.5"
        for="statusFilter"
        >Filtrer par statut</label
      >
      <hlm-select
        class="inline-block w-full md:w-52"
        [(ngModel)]="selectedStatus"
        (ngModelChange)="filterByStatus($event)"
        name="statusFilter"
      >
        <hlm-select-trigger class="w-full justify-between group">
          <hlm-select-value
            placeholder="Choisir un statut"
            class="text-muted-foreground group-data-[placeholder]:text-muted-foreground"
          />
          <hlm-icon
            name="lucideChevronDown"
            size="sm"
            class="text-muted-foreground"
          />
        </hlm-select-trigger>
        <hlm-select-content class="w-full">
          <hlm-option value="all">Tous les statuts</hlm-option>
          <hlm-option value="paid">Payée</hlm-option>
          <hlm-option value="pending_and_payment_pending"
            >En attente</hlm-option
          >
          <hlm-option value="first_reminder_sent"
            >Premier rappel envoyé</hlm-option
          >
          <!-- Assuming you might have this -->
          <!-- Add other relevant statuses from your actual system -->
          <!--
          <hlm-option value="payment_error">Erreur paiement</hlm-option>
          <hlm-option value="draft">Brouillon</hlm-option>
          <hlm-option value="canceled">Annulée</hlm-option>
          <hlm-option value="sended">Envoyée</hlm-option>
          -->
        </hlm-select-content>
      </hlm-select>
    </div>

    <!-- Recherche -->
    <div class="w-full md:flex-1">
      <label
        class="block text-sm font-medium text-gray-700 mb-1.5"
        for="searchInput"
        >Rechercher</label
      >
      <input
        hlmInput
        id="searchInput"
        class="w-full"
        placeholder="Rechercher par N°, client, N° entreprise..."
        (input)="searchInvoices($event)"
      />
    </div>
  </div>

  <!-- Tableau des Factures -->
  @if (paginatedInvoices().length > 0) {
  <div
    class="relative overflow-x-auto rounded-xl border border-gray-200 bg-white"
  >
    <div class="min-w-full overflow-x-auto">
      <table hlmTable class="w-full text-sm text-left">
        <thead class="hidden lg:table-header-group">
          <tr
            class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-200"
          >
            <th hlmTh class="w-20 px-3 py-3 sm:px-4">
              <button
                class="flex items-center gap-1 hover:text-gray-700 transition-colors focus:outline-none"
                (click)="sortBy('invoice_number')"
              >
                <span>N°</span>
                @if (sortField() === 'invoice_number') {
                <span class="text-primary">{{
                  sortOrder() === "asc" ? "↑" : "↓"
                }}</span>
                } @else {
                <hlm-icon
                  name="lucideArrowUpDown"
                  size="xs"
                  class="text-gray-400 h-3 w-3"
                />
                }
              </button>
            </th>
            <th hlmTh class="w-32 px-3 py-3 sm:px-4">
              <button
                class="flex items-center gap-1 hover:text-gray-700 transition-colors focus:outline-none"
                (click)="sortBy('invoice_date')"
              >
                <span>Date</span>
                @if (sortField() === 'invoice_date') {
                <span class="text-primary">{{
                  sortOrder() === "asc" ? "↑" : "↓"
                }}</span>
                } @else {
                <hlm-icon
                  name="lucideArrowUpDown"
                  size="xs"
                  class="text-gray-400 h-3 w-3"
                />
                }
              </button>
            </th>
            <th hlmTh class="px-3 py-3 sm:px-4">Client</th>
            <th hlmTh class="px-3 py-3 sm:px-4">Projet</th>
            <th hlmTh class="w-28 px-3 py-3 sm:px-4 text-right">
              <button
                class="flex items-center justify-end gap-1 w-full hover:text-gray-700 transition-colors focus:outline-none"
                (click)="sortBy('total')"
              >
                <span>Total HTVA</span>
                @if (sortField() === 'total') {
                <span class="text-primary">{{
                  sortOrder() === "asc" ? "↑" : "↓"
                }}</span>
                } @else {
                <hlm-icon
                  name="lucideArrowUpDown"
                  size="xs"
                  class="text-gray-400 h-3 w-3"
                />
                }
              </button>
            </th>
            <th hlmTh class="px-3 py-3 sm:px-4 text-right">TVAC</th>
            <th hlmTh class="w-36 px-3 py-3 sm:px-4 text-center">Statut</th>
            <th hlmTh class="w-48 px-3 py-3 sm:px-4 text-right">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          @for (invoice of paginatedInvoices(); track invoice.id) {
          <tr
            hlmTrow
            class="bg-white hover:bg-gray-50 transition-colors flex flex-col lg:table-row mb-3 lg:mb-0 rounded-lg lg:rounded-none shadow-sm lg:shadow-none border border-gray-100 lg:border-0"
          >
            <td
              hlmTd
              class="px-3 py-2 sm:px-4 lg:py-3 flex lg:table-cell items-center justify-between lg:justify-start border-b lg:border-none border-gray-100"
            >
              <span
                class="font-medium lg:hidden text-xs text-gray-500 uppercase mr-2"
                >N° :</span
              >
              <span class="whitespace-nowrap font-medium text-gray-800">{{
                formatInvoiceNumber(invoice)
              }}</span>
            </td>
            <td
              hlmTd
              class="px-3 py-2 sm:px-4 lg:py-3 flex lg:table-cell items-center justify-between lg:justify-start border-b lg:border-none border-gray-100"
            >
              <span
                class="font-medium lg:hidden text-xs text-gray-500 uppercase mr-2"
                >Date :</span
              >
              <span class="whitespace-nowrap text-gray-600">{{
                invoice.invoice_date | date : "dd/MM/yyyy"
              }}</span>
            </td>
            <td
              hlmTd
              class="px-3 py-2 sm:px-4 lg:py-3 border-b lg:border-none border-gray-100"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-medium flex-shrink-0 text-sm"
                >
                  {{ invoice.client.name.charAt(0).toUpperCase() || "A" }}
                </div>
                <div class="min-w-0 flex-grow">
                  <div class="font-semibold text-gray-900 truncate text-sm">
                    {{ invoice.client.name }}
                  </div>
                  <div class="text-xs text-gray-500 truncate">
                    {{ invoice.client.email }}
                  </div>
                  <div class="text-xs text-gray-500 truncate">
                    {{ invoice.client.phone }}
                  </div>
                  @if(invoice.client.company_number) {
                  <div class="text-[10px] text-gray-400 truncate">
                    N° Ent: {{ invoice.client.company_number }}
                  </div>
                  }
                </div>
              </div>
            </td>
            <td
              hlmTd
              class="px-3 py-2 sm:px-4 lg:py-3 border-b lg:border-none border-gray-100"
            >
              <div class="flex items-center gap-3">
                {{
                  invoice.main_account
                    ? invoice.main_account.username
                    : invoice.group_account
                    ? invoice.group_account.username
                    : "N/A"
                }}
              </div>
            </td>
            <td
              hlmTd
              class="px-3 py-2 sm:px-4 lg:py-3 flex lg:table-cell items-center justify-between lg:justify-end lg:text-right border-b lg:border-none border-gray-100"
            >
              <span
                class="font-medium lg:hidden text-xs text-gray-500 uppercase mr-2"
                >Total HTVA :</span
              >
              <span
                class="font-semibold text-sm whitespace-nowrap text-gray-800"
                >{{ invoice.price_htva | euroFormat }}</span
              >
            </td>
            <td
              hlmTd
              class="px-3 py-2 sm:px-4 lg:py-3 flex lg:table-cell items-center justify-between lg:justify-end lg:text-right border-b lg:border-none border-gray-100"
            >
              <span
                class="font-medium lg:hidden text-xs text-gray-500 uppercase mr-2"
              >Total TVAc :</span
              >
              <span
                class="font-semibold text-sm whitespace-nowrap text-gray-800"
              >{{ invoice.total | euroFormat }}</span
              >
            </td>
            <td
              hlmTd
              class="px-3 py-2 sm:px-4 lg:py-3 flex lg:table-cell items-center justify-between lg:justify-center border-b lg:border-none border-gray-100"
            >
              <span
                class="font-medium lg:hidden text-xs text-gray-500 uppercase mr-2"
                >Statut :</span
              >
              <span
                class="inline-flex items-center justify-center rounded-full px-2.5 py-0.5 text-xs font-semibold leading-none min-w-[100px] text-center border"
                [ngClass]="getStatusClasses(invoice.status)"
              >
                {{ getStatusLabel(invoice.status) }}
              </span>
            </td>
            <td hlmTd class="px-3 py-2 sm:px-4 lg:py-3">
              <div
                class="flex flex-col lg:flex-row items-stretch lg:items-center justify-end gap-1.5 sm:gap-2"
              >
                <button
                  hlmBtn
                  variant="ghost"
                  size="sm"
                  class="flex items-center justify-center gap-1.5 w-full lg:w-auto text-xs whitespace-nowrap px-2 py-1.5 border border-transparent hover:border-gray-200 hover:bg-gray-100 text-gray-600 hover:text-gray-800"
                  (click)="downloadInvoice(invoice)"
                >
                  <hlm-icon
                    size="sm"
                    name="lucideFileDown"
                    class="h-3.5 w-3.5"
                  />
                  <span class="lg:hidden">Télécharger</span>
                </button>
                <hlm-dialog *ngIf="invoice.status !== 'paid'" (closed)="cancelEdit()">
                  <!-- Bouton déclencheur du dialog -->
                  <button
                    hlmBtn
                    variant="ghost"
                    size="sm"
                    class="flex items-center justify-center gap-1.5 w-full lg:w-auto text-xs whitespace-nowrap px-2 py-1.5 border border-transparent hover:border-green-200 hover:bg-green-50 text-green-600 hover:text-green-700"
                    brnDialogTrigger
                  >
                  <hlm-icon
                    size="sm"
                    name="lucideCheckCircle"
                    class="h-3.5 w-3.5"
                  />
                  <span class="lg:hidden">Marquer Payée</span>
                  </button>
                  <!-- Contenu du dialog -->
                  <hlm-dialog-content *brnDialogContent="let ctx" class="sm:max-w-md w-full mx-4 sm:mx-auto rounded-xl shadow-lg">
                    <hlm-dialog-header>
                      <h3 hlmDialogTitle class="text-lg font-semibold text-gray-800">
                        Récapitulatif de la facture #{{ formatInvoiceNumber(invoice) }}
                      </h3>
                      <p hlmDialogDescription class="text-sm text-gray-500">
                        Voici les informations principales liées à cette facture.
                      </p>
                    </hlm-dialog-header>

                    <div class="mt-4 space-y-3 text-sm text-gray-700">
                      <div class="flex justify-between">
                        <span class="font-medium">Nom du projet :</span>
                        <span class="text-right text-gray-900">
                           {{
                            invoice.main_account
                              ? invoice.main_account.username
                              : invoice.group_account
                                ? invoice.group_account.username
                                : "N/A"
                          }}
                       </span>
                      </div>
                      <div class="flex justify-between">
                        <span class="font-medium">Client :</span>
                        <span class="text-right text-gray-900">{{ invoice.client.name }}</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="font-medium">HTVA :</span>
                        <span class="text-right text-gray-900">{{ invoice.price_htva | euroFormat }}</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="font-medium">Total TVAC :</span>
                        <span class="text-right text-gray-900">{{ invoice.total | euroFormat }}</span>
                      </div>



                      <div class="flex flex-col gap-3 w-full max-w-md">
                        <div>
                          <div class="flex justify-between items-center">
                            <span class="font-medium">Commission :</span>
                            <div *ngIf="!isEditing" class="flex items-center gap-2">
                              <button
                                (click)="editCommission(invoice)"
                                class="text-blue-600 hover:text-blue-800 transition"
                                title="Modifier"
                              >
                                ✏️
                              </button>
                              <span class="text-gray-900">
                                {{
                                  invoice?.main_account?.commissionPourcentage ??
                                  invoice?.group_account?.commissionPourcentage ??
                                  invoice?.main_account?.commission ??
                                  invoice?.group_account?.commission ??
                                  'N/A'
                                }}
                                <ng-container *ngIf="(invoice?.main_account?.commissionPourcentage ?? invoice?.group_account?.commissionPourcentage) != null">%</ng-container>

                                <ng-container *ngIf="(invoice?.main_account?.commission ?? invoice?.group_account?.commission) != null">€</ng-container>
                              </span>
                            </div>
                          </div>
                          <div *ngIf="isEditing" class="mt-2 flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                            <div class="flex gap-3">
                              <label class="flex items-center gap-1 cursor-pointer text-sm">
                                <input
                                  type="radio"
                                  name="commissionType"
                                  [(ngModel)]="commissionType"
                                  value="percent"
                                  class="cursor-pointer"
                                />
                                %
                              </label>
                              <label class="flex items-center gap-1 cursor-pointer text-sm">
                                <input
                                  type="radio"
                                  name="commissionType"
                                  [(ngModel)]="commissionType"
                                  value="fixed"
                                  class="cursor-pointer"
                                />
                                Montant
                              </label>
                            </div>
                            <div *ngIf="commissionType === 'percent'" class="flex items-center gap-1">
                              <input
                                type="number"
                                [(ngModel)]="editedCommissionPercent"
                                min="0"
                                max="100"
                                class="w-20 p-1 border rounded text-right"
                                placeholder=""
                              />
                              <span>%</span>
                            </div>
                            <div *ngIf="commissionType === 'fixed'" class="flex items-center gap-1">
                              <input
                                type="number"
                                [(ngModel)]="editedCommissionFixed"
                                min="0"
                                [max]="invoice.price_htva"
                                class="w-24 p-1 border rounded text-right"
                                placeholder="Montant"
                              />
                              <span>€</span>
                            </div>
                            <div class="flex gap-2 ml-auto">
                              <button
                                (click)="saveCommission(invoice)"
                                class="text-green-600 hover:text-green-800 font-bold"
                                title="Enregistrer"
                                [disabled]="commissionType === 'fixed' && editedCommissionFixed != null && editedCommissionFixed > invoice.price_htva"
                              >
                                ✅
                              </button>
                              <button
                                (click)="cancelEdit()"
                                class="text-red-500 hover:text-red-700 font-bold"
                                title="Annuler"
                              >
                                ❌
                              </button>
                            </div>
                          </div>
                        </div>
                        <div class="flex justify-between">
                          <span class="font-medium">Montant de la commission :</span>
                          <span class="text-right text-gray-900">
                            {{ calculateCommissionAmount(invoice) | euroFormat }}
                          </span>
                        </div>
                      </div>

                      <!-- Ajoute d'autres champs si besoin -->
                    </div>

                    <div class="flex flex-col sm:flex-row justify-end mt-6 gap-2">
                      <button
                        hlmBtn
                        type="button"
                        (click)="ctx.close()"
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition font-medium shadow-sm border border-gray-200"
                      >
                        Fermer
                      </button>
                      <button
                        hlmBtn
                        type="button"
                        [disabled]="isEditing"
                        (click)="markAsPaid(invoice.id)"
                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition font-semibold shadow-sm border border-green-700 disabled:bg-gray-200 disabled:text-gray-400"
                      >
                        Validé le payement
                      </button>
                    </div>
                  </hlm-dialog-content>
                </hlm-dialog>
                <button
                  *ngIf="invoice.status === 'paid'"
                  hlmBtn
                  variant="ghost"
                  size="sm"
                  class="flex items-center justify-center gap-1.5 w-full lg:w-auto text-xs whitespace-nowrap px-2 py-1.5 border border-transparent hover:border-gray-200 hover:bg-gray-100 text-gray-600 hover:text-gray-800"
                  (click)="cancel(invoice)"
                >
                  ❌
                  <span class="lg:hidden">Annuler</span>
                </button>

              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <nav hlmPagination class="mt-4 sm:mt-6 flex justify-center">
    <ul
      hlmPaginationContent
      class="flex flex-wrap gap-1 justify-center items-center"
    >
      <li hlmPaginationItem class="mx-0.5 sm:mx-1">
        <button
          hlmBtn
          variant="ghost"
          class="px-2 md:px-3 py-1.5 text-xs sm:text-sm font-medium"
          [disabled]="currentPage() === 1"
          (click)="onPageChange(currentPage() - 1)"
        >
          Précédent
        </button>
      </li>

      @for (page of getVisiblePages(); track $index) { @if (page === 'ellipsis')
      {
      <li hlmPaginationItem class="mx-0.5 sm:mx-1">
        <span class="px-2 md:px-3 py-1.5 text-xs sm:text-sm">...</span>
      </li>
      } @else {
      <li hlmPaginationItem class="mx-0.5 sm:mx-1">
        <button
          hlmBtn
          [variant]="currentPage() === page ? 'default' : 'outline'"
          class="min-w-[32px] sm:min-w-[36px] h-8 sm:h-9 px-2 md:px-3 py-1.5 text-xs sm:text-sm font-medium"
          (click)="onPageChange(page)"
        >
          {{ page }}
        </button>
      </li>
      } }

      <li hlmPaginationItem class="mx-0.5 sm:mx-1">
        <button
          hlmBtn
          variant="ghost"
          class="px-2 md:px-3 py-1.5 text-xs sm:text-sm font-medium"
          [disabled]="currentPage() === totalPages()"
          (click)="onPageChange(currentPage() + 1)"
        >
          Suivant
        </button>
      </li>
    </ul>
  </nav>

  } @else {
  <div
    class="py-12 text-center rounded-xl border border-dashed border-gray-300 bg-white mt-6"
  >
    <div class="flex flex-col items-center gap-3 sm:gap-4">
      <div
        class="w-12 h-12 sm:w-14 sm:h-14 md:w-16 md:h-16 rounded-full bg-gray-100 flex items-center justify-center"
      >
        <hlm-icon name="lucideFileText" size="lg" class="text-gray-400" />
      </div>
      <div class="space-y-1 sm:space-y-2">
        <h3 class="text-base sm:text-lg font-semibold text-gray-900">
          Aucune facture trouvée
        </h3>
        <p class="text-sm text-gray-500 max-w-md mx-auto">
          @if (searchTerm() || selectedStatus() !== 'all') { Aucune facture ne
          correspond à vos critères de recherche ou de filtre actuels. } @else {
          Il n'y a actuellement aucune facture enregistrée. }
        </p>
      </div>
    </div>
  </div>
  }
</div>
<hlm-toaster />
