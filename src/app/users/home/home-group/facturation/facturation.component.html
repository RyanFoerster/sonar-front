<!-- En-tête -->
<div class="flex justify-between items-center mb-6 p-4">
  <h1 class="text-2xl font-bold">Facturation</h1>
  <div class="flex gap-4">
    <a
      routerLink="new-quote"
      [queryParams]="{ typeOfProjet: typeOfProjet() }"
      class="rounded-full text-[10px] font-semibold h-auto bg-gray-sonar text-black md:flex md:justify-center md:items-center md:gap-2 md:min-w-4/5 md:px-10 md:text-lg hover:bg-gray-sonar/80"
      hlmBtn
    >
      Nouveau devis
    </a>
    @if (connectedUser()?.role === "ADMIN") {
    <a
      routerLink="new-credit-note"
      [queryParams]="{ typeOfProjet: typeOfProjet() }"
      class="rounded-full text-[10px] font-semibold h-auto bg-gray-sonar text-black md:flex md:justify-center md:items-center md:gap-2 md:min-w-4/5 md:px-10 md:text-lg hover:bg-gray-sonar/80"
      hlmBtn
    >
      Nouvelle note de crédit
    </a>
    }
  </div>
</div>

<!-- Filtres -->
<div class="flex flex-wrap gap-4 mb-6 p-4">
  <button
    hlmBtn
    [variant]="currentFilter === 'all' ? 'default' : 'outline'"
    (click)="filterList('all')"
    class="rounded-full"
  >
    Tout afficher
  </button>
  <button
    hlmBtn
    [variant]="currentFilter === 'quotes' ? 'default' : 'outline'"
    (click)="filterList('quotes')"
    class="rounded-full"
  >
    Devis en attente
  </button>
  <button
    hlmBtn
    [variant]="currentFilter === 'invoiced_quotes' ? 'default' : 'outline'"
    (click)="filterList('invoiced_quotes')"
    class="rounded-full"
  >
    Devis facturés
  </button>
  <button
    hlmBtn
    [variant]="currentFilter === 'credit-note' ? 'default' : 'outline'"
    (click)="filterList('credit-note')"
    class="rounded-full"
  >
    Notes de crédit
  </button>
</div>

<!-- Tableau -->
<div
  class="relative overflow-x-auto rounded-xl border border-gray-200 bg-white p-4"
>
  <table class="w-full text-sm text-left">
    <caption
      class="p-5 text-lg font-semibold text-left text-gray-900 bg-white border-b border-gray-200"
    >
      Liste des devis et notes de crédit
    </caption>
    <thead>
      <tr
        class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200"
      >
        <th scope="col" class="px-6 py-4 font-medium">N°</th>
        <th scope="col" class="px-6 py-4 font-medium">Date</th>
        <th scope="col" class="px-6 py-4 font-medium">Client</th>
        <th scope="col" class="px-6 py-4 font-medium">Type</th>
        <th scope="col" class="px-6 py-4 font-medium">Total</th>
        <th scope="col" class="px-6 py-4 font-medium text-right">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-200">
      @if (typeOfProjet() === "PRINCIPAL" && connectedUser()?.role === "ADMIN")
      { @for (doc of getAllDocuments(); track doc.id) { @if (doc.documentType
      === 'quote') {
      <tr class="bg-white hover:bg-gray-50 transition-colors">
        <td class="px-6 py-4">D-{{ doc.quote_number }}</td>
        <td class="px-6 py-4">
          {{ doc.quote_date | date : "dd/MM/yyyy" }}
        </td>
        <td class="px-6 py-4">
          <div class="flex items-center gap-3">
            <div
              class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600"
            >
              {{ doc.client.name.charAt(0).toUpperCase() }}
            </div>
            <div>
              <div class="font-medium text-gray-900">
                {{ doc.client.name }}
              </div>
              <div class="text-xs text-gray-500">{{ doc.client.email }}</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4">
          <span
            class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium"
            [ngClass]="{
              'bg-blue-50 text-blue-700': !doc.invoice,
              'bg-green-50 text-green-700': doc.invoice
            }"
          >
            {{ doc.invoice ? "Devis facturé" : "Devis en attente" }}
          </span>
        </td>
        <td class="px-6 py-4 font-medium">{{ doc.total | euroFormat }}</td>
        <td class="px-6 py-4">
          <div class="flex items-center justify-end gap-2">
            <button
              hlmBtn
              variant="ghost"
              size="sm"
              class="flex items-center gap-2"
              [ngClass]="{ 'opacity-50 cursor-not-allowed': doc.invoice }"
              (click)="generateQuotePDF(doc)"
              [disabled]="doc.invoice"
            >
              <hlm-icon size="sm" name="lucideFileDown" />
              <span class="hidden sm:inline">Télécharger devis</span>
            </button>
            @if (doc.invoice) {
            <button
              hlmBtn
              variant="ghost"
              size="sm"
              class="flex items-center gap-2"
              (click)="generateInvoicePDF(doc.invoice)"
            >
              <hlm-icon size="sm" name="lucideFileDown" />
              <span class="hidden sm:inline">Télécharger facture</span>
            </button>
            } @if (!doc.invoice) {
            <button
              hlmBtn
              variant="ghost"
              size="sm"
              class="flex items-center gap-2"
              routerLink="new-quote"
              [queryParams]="{
                typeOfProjet: typeOfProjet(),
                updatedQuoteId: doc.id
              }"
            >
              <hlm-icon size="sm" name="lucideEdit" />
              <span class="hidden sm:inline">Modifier</span>
            </button>
            <hlm-alert-dialog>
              <button
                hlmBtn
                variant="default"
                size="sm"
                class="flex items-center gap-2"
                brnAlertDialogTrigger
              >
                <hlm-icon size="sm" name="lucideFileText" />
                <span class="hidden sm:inline">Facturer</span>
              </button>
              <hlm-alert-dialog-content *brnAlertDialogContent="let ctx">
                <hlm-alert-dialog-header>
                  <h3 hlmAlertDialogTitle>Créer la facture</h3>
                  <p hlmAlertDialogDescription>
                    Cette action est irréversible.
                  </p>
                </hlm-alert-dialog-header>
                <hlm-alert-dialog-footer>
                  <button hlmBtn variant="outline" (click)="ctx.close()">
                    Annuler
                  </button>
                  <button
                    hlmBtn
                    variant="default"
                    (click)="createInvoice(doc, ctx)"
                  >
                    Créer
                  </button>
                </hlm-alert-dialog-footer>
              </hlm-alert-dialog-content>
            </hlm-alert-dialog>
            }
          </div>
        </td>
      </tr>
      } @if (doc.documentType === 'credit_note') {
      <tr class="bg-red-50 hover:bg-red-100 transition-colors">
        <td class="px-6 py-4">NC-{{ doc.invoice_number }}</td>
        <td class="px-6 py-4">
          {{ doc.invoice_date | date : "dd/MM/yyyy" }}
        </td>
        <td class="px-6 py-4">
          <div class="flex items-center gap-3">
            <div
              class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600"
            >
              {{ doc.client?.name.charAt(0).toUpperCase() }}
            </div>
            <div>
              <div class="font-medium text-gray-900">
                {{ doc.client?.name }}
              </div>
              <div class="text-xs text-gray-500">
                {{ doc.client?.email }}
              </div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4">
          <span
            class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium bg-red-100 text-red-700"
          >
            Note de crédit
          </span>
        </td>
        <td class="px-6 py-4 font-medium">{{ doc.total | euroFormat }}</td>
        <td class="px-6 py-4">
          <div class="flex items-center justify-end gap-2">
            <button
              hlmBtn
              variant="ghost"
              size="sm"
              class="flex items-center gap-2"
              (click)="generateCreditNotePdf(doc)"
            >
              <hlm-icon size="sm" name="lucideFileDown" />
              <span class="hidden sm:inline">Télécharger note de crédit</span>
            </button>
          </div>
        </td>
      </tr>
      } } }
    </tbody>
  </table>
</div>
