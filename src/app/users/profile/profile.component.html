<div class="flex flex-col justify-center gap-5">
  <div
    class="background-div h-40 max-w-full md:h-60 relative mx-10 overflow-hidden rounded-3xl shadow"
  >
    <div
      class="flex justify-center items-center py-6 px-2 md:flex md:w-3/5 md:py-10 md:pl-10"
    >
      <div class="flex justify-center items-center">
        <div
          class="size-28 md:size-40 rounded-full bg-gray-sonar flex justify-center items-center"
        >
          <p
            class="text-white text-6xl bg-primary rounded-full size-24 md:size-36 flex justify-center items-center"
          >
            {{
              connectedUser()?.firstName?.slice(0, 1) ||
                connectedUser()?.name?.slice(0, 1)
            }}
          </p>
        </div>
      </div>

      <div class="flex flex-col mx-2 w-1/2">
        <p class="flex text-[8px] md:text-sm text-white font-light">
          {{ connectedUser()?.comptePrincipal?.username }}
        </p>
        <p class="flex text-lg leading-none md:text-3xl text-white font-bold">
          {{ connectedUser()?.firstName }}
        </p>
        <p class="flex text-lg leading-none md:text-3xl text-white font-bold">
          {{ connectedUser()?.name }}
        </p>
        <p class="flex text-[8px] md:text-lg text-white font-light">
          {{ connectedUser()?.email }}
        </p>
      </div>
    </div>

    <div
      class="absolute bottom-2 right-2 size-5 bg-white rounded-full flex justify-center items-center"
    >
      <hlm-icon class="w-3" name="lucideEdit" />
    </div>
  </div>

  <div
    class="bg-gray-sonar flex flex-col-reverse md:flex-col mx-10 md:w-3/5 rounded-3xl"
  >
    <div class="flex justify-between md:pt-5 px-5">
      <p class="text-xl font-bold hidden md:block">Informations</p>
      <div class="flex flex-col md:px-0 md:pb-0 justify-center w-full md:w-fit">
        <hlm-dialog class="flex pb-2 justify-start w-full">
          <button
            class="rounded-full text-xs w-auto hidden md:flex md:text-base justify-end"
            id="edit-profile"
            brnDialogTrigger
            hlmBtn
          >
            Modifier le profil
          </button>
          <hlm-dialog-content
            class="p-6 rounded-xl m-4 w-11/12 md:max-w-lg"
            *brnDialogContent="let ctx"
          >
            <hlm-dialog-header>
              <h3 hlmDialogTitle>Modifier le profil</h3>
              <p class="text-xs md:text-base" hlmDialogDescription>
                Apportez des modifications à votre profil ici. Cliquez sur
                "Enregistrer" lorsque vous avez terminé.
              </p>
            </hlm-dialog-header>
            <form
              [formGroup]="updateUserForm"
              class="py-4 grid gap-4"
              (ngSubmit)="updateUser(ctx)"
            >
              <div
                class="grid grid-cols-4 items-center gap-x-4 gap-y-2 *:text-sm"
              >
                <label
                  hlmLabel
                  for="username"
                  class="text-left font-medium col-span-4 md:col-span-1 md:text-right"
                  >Username</label
                >
                <input
                  formControlName="username"
                  hlmInput
                  id="username"
                  placeholder="Votre nom d'utilisateur"
                  class="col-span-4 md:col-span-3 rounded-md px-3 py-1.5 border focus:ring-1 focus:ring-primary focus:border-primary"
                />
              </div>

              <div
                class="grid grid-cols-4 items-center gap-x-4 gap-y-2 *:text-sm"
              >
                <label
                  hlmLabel
                  for="lastname"
                  class="text-left font-medium col-span-4 md:col-span-1 md:text-right"
                  >Nom</label
                >
                <input
                  formControlName="name"
                  hlmInput
                  id="lastname"
                  placeholder="Votre nom de famille"
                  class="col-span-4 md:col-span-3 rounded-md px-3 py-1.5 border focus:ring-1 focus:ring-primary focus:border-primary"
                />
              </div>

              <div
                class="grid grid-cols-4 items-center gap-x-4 gap-y-2 *:text-sm"
              >
                <label
                  hlmLabel
                  for="firstname"
                  class="text-left font-medium col-span-4 md:col-span-1 md:text-right"
                  >Prénom</label
                >
                <input
                  formControlName="firstName"
                  hlmInput
                  id="firstname"
                  placeholder="Votre prénom"
                  class="col-span-4 md:col-span-3 rounded-md px-3 py-1.5 border focus:ring-1 focus:ring-primary focus:border-primary"
                />
              </div>

              <div
                class="grid grid-cols-4 items-center gap-x-4 gap-y-2 *:text-sm"
              >
                <label
                  hlmLabel
                  for="nationalNumber"
                  class="text-left font-medium col-span-4 md:col-span-1 md:text-right"
                  >Numéro national</label
                >
                <input
                  formControlName="numeroNational"
                  hlmInput
                  id="nationalNumber"
                  placeholder="Ex: 90.01.01-123.45"
                  class="col-span-4 md:col-span-3 rounded-md px-3 py-1.5 border focus:ring-1 focus:ring-primary focus:border-primary"
                />
              </div>

              <div
                class="grid grid-cols-4 items-center gap-x-4 gap-y-2 *:text-sm"
              >
                <label
                  hlmLabel
                  for="phone"
                  class="text-left font-medium col-span-4 md:col-span-1 md:text-right"
                  >Téléphone</label
                >
                <input
                  formControlName="telephone"
                  hlmInput
                  id="phone"
                  placeholder="Votre numéro de téléphone"
                  class="col-span-4 md:col-span-3 rounded-md px-3 py-1.5 border focus:ring-1 focus:ring-primary focus:border-primary"
                />
              </div>

              <div
                class="grid grid-cols-4 items-center gap-x-4 gap-y-2 *:text-sm"
              >
                <label
                  hlmLabel
                  for="email"
                  class="text-left font-medium col-span-4 md:col-span-1 md:text-right"
                  >E-mail</label
                >
                <input
                  formControlName="email"
                  hlmInput
                  type="email"
                  id="email"
                  placeholder="Votre adresse e-mail"
                  class="col-span-4 md:col-span-3 rounded-md px-3 py-1.5 border focus:ring-1 focus:ring-primary focus:border-primary"
                />
              </div>

              <div
                class="grid grid-cols-4 items-center gap-x-4 gap-y-2 *:text-sm"
              >
                <label
                  hlmLabel
                  for="iban"
                  class="text-left font-medium col-span-4 md:col-span-1 md:text-right"
                  >Compte bancaire</label
                >
                <input
                  formControlName="iban"
                  hlmInput
                  id="iban"
                  placeholder="Votre numéro IBAN"
                  class="col-span-4 md:col-span-3 rounded-md px-3 py-1.5 border focus:ring-1 focus:ring-primary focus:border-primary"
                />
              </div>

              <div
                class="grid grid-cols-4 items-center gap-x-4 gap-y-2 *:text-sm"
              >
                <label
                  hlmLabel
                  for="address"
                  class="text-left font-medium col-span-4 md:col-span-1 md:text-right"
                  >Adresse</label
                >
                <input
                  formControlName="address"
                  hlmInput
                  id="address"
                  placeholder="Votre adresse postale"
                  class="col-span-4 md:col-span-3 rounded-md px-3 py-1.5 border focus:ring-1 focus:ring-primary focus:border-primary"
                />
              </div>
              <button
                class="w-full mt-4 md:mt-6 py-2 px-4 rounded-md text-sm font-semibold"
                hlmBtn
                type="submit"
              >
                Enregistrer
              </button>
            </form>
          </hlm-dialog-content>
          <button
            class="rounded-full text-xs w-full flex md:hidden md:text-base"
            id="edit-profile"
            brnDialogTrigger
            hlmBtn
          >
            Modifier le profil
          </button>
        </hlm-dialog>
      </div>
    </div>

    <div class="p-5 flex flex-col gap-2">
      <div class="flex">
        <p class="font-bold text-[9px] md:text-sm w-28 md:w-56">Adresse</p>
        @if (!connectedUser()?.address) {
        <p class="text-[9px] md:text-sm text-red-500">
          Aucune adresse enregistrer cliquer sur le bouton modifier le profil
          afin d'en définir une
        </p>
        }
        <p class="text-[9px] md:text-sm">{{ connectedUser()?.address }}</p>
      </div>

      <div class="flex pt-2 border-t border-gray-600 mt-2">
        <p class="font-bold text-[9px] md:text-sm w-28 md:w-56">
          Notifications
        </p>
        @if (notificationsSupported()) {
        <div class="flex items-center gap-2">
          <!-- Switch personnalisé sans bouton -->
          <div
            class="custom-switch cursor-pointer"
            (click)="toggleNotifications(!notificationsEnabled())"
            (keydown.enter)="toggleNotifications(!notificationsEnabled())"
            tabindex="0"
            role="switch"
            [attr.aria-checked]="notificationsEnabled()"
            [attr.aria-label]="
              notificationsEnabled()
                ? 'Désactiver les notifications'
                : 'Activer les notifications'
            "
            [class.is-processing]="isProcessingNotificationPermission()"
          >
            <div
              class="switch-track"
              [ngClass]="{
                'switch-track-active': notificationsEnabled(),
                'switch-track-inactive': !notificationsEnabled(),
                'opacity-50': isProcessingNotificationPermission()
              }"
            >
              <div
                class="switch-thumb relative"
                [ngClass]="{
                  'switch-thumb-active': notificationsEnabled(),
                  'switch-thumb-inactive': !notificationsEnabled()
                }"
              >
                <!-- Indicateur de chargement -->
                @if (isProcessingNotificationPermission()) {
                <div
                  class="h-3 w-3 absolute top-0 bottom-0 left-0 right-0 m-auto"
                >
                  <div
                    class="animate-spin h-3 w-3 border-2 border-primary rounded-full border-t-transparent"
                  ></div>
                </div>
                }
              </div>
            </div>
          </div>

          <div class="flex items-center">
            @if (notificationsEnabled()) {
            <hlm-icon
              name="lucideBell"
              class="text-green-600 w-4 h-4 md:w-5 md:h-5"
            ></hlm-icon>
            <span class="text-[9px] md:text-sm text-green-600 ml-1"
              >Activées</span
            >
            } @else {
            <hlm-icon
              name="lucideBellOff"
              class="text-red-600 w-4 h-4 md:w-5 md:h-5"
            ></hlm-icon>
            <span class="text-[9px] md:text-sm text-red-600 ml-1"
              >Désactivées</span
            >
            }
          </div>
        </div>
        } @else {
        <p class="text-[9px] md:text-sm text-red-500">
          Les notifications ne sont pas supportées par votre navigateur
        </p>
        }
      </div>

      <div class="flex">
        <p class="font-bold text-[9px] md:text-sm w-28 md:w-56">
          Numéro de téléphone
        </p>
        <p class="text-[9px] md:text-sm">{{ connectedUser()?.telephone }}</p>
      </div>

      <div class="flex">
        <p class="font-bold text-[9px] md:text-sm w-28 md:w-56">
          Numéro national
        </p>
        <p class="text-[9px] md:text-sm">
          {{ connectedUser()?.numeroNational }}
        </p>
      </div>

      <div class="flex">
        <p class="font-bold text-[9px] md:text-sm w-28 md:w-56">
          Compte bancaire
        </p>
        <p class="text-[9px] md:text-sm">{{ connectedUser()?.iban }}</p>
      </div>
    </div>
  </div>

  <!-- Nouvelle section pour les invitations de groupe -->
  <div
    class="bg-gray-sonar flex flex-col mx-10 md:w-3/5 rounded-3xl overflow-hidden"
  >
    <div class="flex justify-between px-5 py-4 border-b border-gray-200">
      <div class="flex items-center">
        <hlm-icon
          name="lucideUsers"
          class="w-5 h-5 text-primary mr-2"
        ></hlm-icon>
        <p class="text-xl font-bold">Invitations de groupe</p>
      </div>
      <div *ngIf="pendingInvitations().length > 0" class="flex items-center">
        <span class="bg-primary text-white rounded-full px-2 py-0.5 text-xs">
          {{ pendingInvitations().length }}
        </span>
      </div>
    </div>

    <div class="p-2 md:p-4">
      <!-- Loading state -->
      <div *ngIf="isLoadingInvitations()" class="flex justify-center py-6">
        <div
          class="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full"
        ></div>
      </div>

      <!-- No invitations state -->
      <div
        *ngIf="!isLoadingInvitations() && pendingInvitations().length === 0"
        class="flex flex-col items-center justify-center py-8 text-center"
      >
        <hlm-icon
          name="lucideInbox"
          class="w-12 h-12 text-gray-400 mb-3"
        ></hlm-icon>
        <p class="text-sm text-gray-500">
          Vous n'avez aucune invitation de groupe en attente
        </p>
      </div>

      <!-- List of invitations -->
      <div
        *ngIf="!isLoadingInvitations() && pendingInvitations().length > 0"
        class="space-y-3"
      >
        <div
          *ngFor="let invitation of pendingInvitations()"
          class="bg-white rounded-xl p-4 shadow-sm"
        >
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center mb-1">
                <div
                  class="w-10 h-10 rounded-full flex items-center justify-center bg-primary text-white font-bold text-sm mr-3"
                >
                  {{
                    invitation.group.username
                      ? invitation.group.username.substring(0, 2).toUpperCase()
                      : "GP"
                  }}
                </div>
                <div>
                  <h3 class="font-medium">
                    {{ invitation.group.username || "Groupe" }}
                  </h3>
                  <p class="text-xs text-gray-500">
                    Invitation reçue {{ getRelativeTime(invitation.createdAt) }}
                  </p>
                </div>
              </div>
              <p
                *ngIf="invitation.message"
                class="text-sm text-gray-600 mt-2 ml-13 italic"
              >
                "{{ invitation.message }}"
              </p>
            </div>
          </div>
          <div class="flex justify-end gap-2 mt-3">
            <button
              (click)="respondToInvitation(invitation.id, false)"
              class="py-1.5 px-4 rounded-full text-xs border border-red-500 text-red-500 hover:bg-red-50 transition-colors relative"
              [disabled]="isProcessingInvitation(invitation.id)"
            >
              <span [class.opacity-0]="isProcessingInvitation(invitation.id)"
                >Refuser</span
              >
              <div
                *ngIf="isProcessingInvitation(invitation.id)"
                class="absolute inset-0 flex items-center justify-center"
              >
                <div
                  class="animate-spin h-3 w-3 border-2 border-red-500 rounded-full border-t-transparent"
                ></div>
              </div>
            </button>
            <button
              (click)="respondToInvitation(invitation.id, true)"
              class="py-1.5 px-4 rounded-full text-xs bg-primary text-white hover:bg-primary-dark transition-colors relative"
              [disabled]="isProcessingInvitation(invitation.id)"
            >
              <span [class.opacity-0]="isProcessingInvitation(invitation.id)"
                >Accepter</span
              >
              <div
                *ngIf="isProcessingInvitation(invitation.id)"
                class="absolute inset-0 flex items-center justify-center"
              >
                <div
                  class="animate-spin h-3 w-3 border-2 border-white rounded-full border-t-transparent"
                ></div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Nouvelle section pour les événements de l'utilisateur -->
  <div
    class="bg-gray-sonar flex flex-col mx-10 md:w-3/5 rounded-3xl overflow-hidden events-section"
  >
    <div class="flex justify-between px-5 py-4 border-b border-gray-200">
      <div class="flex items-center">
        <hlm-icon
          name="lucideCalendar"
          class="w-5 h-5 text-primary mr-2"
        ></hlm-icon>
        <p class="text-xl font-bold">Mes événements</p>
      </div>
    </div>

    <!-- Tabs de filtrage -->
    <div class="flex border-b border-gray-200 px-1">
      <button
        *ngFor="let tab of eventTabs"
        [class.border-primary]="currentEventTab() === tab.value"
        [class.border-b-2]="currentEventTab() === tab.value"
        [class.text-primary]="currentEventTab() === tab.value"
        class="flex-1 py-3 text-xs md:text-sm font-medium transition-colors"
        (click)="filterEvents(tab.value)"
      >
        {{ tab.label }}
        <span
          *ngIf="tab.value === 'pending' && pendingEventCount() > 0"
          class="inline-flex items-center justify-center ml-1 bg-primary text-white text-xs rounded-full w-5 h-5"
        >
          {{ pendingEventCount() }}
        </span>
      </button>
    </div>

    <div class="p-2 md:p-4">
      <!-- Loading state -->
      <div *ngIf="isLoadingEvents()" class="flex justify-center py-6">
        <div
          class="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full"
        ></div>
      </div>

      <!-- Empty state -->
      <div
        *ngIf="!isLoadingEvents() && filteredEvents().length === 0"
        class="flex flex-col items-center justify-center py-8 text-center"
      >
        <hlm-icon
          name="lucideCalendarX"
          class="w-12 h-12 text-gray-400 mb-3"
        ></hlm-icon>
        <p class="text-sm text-gray-500" [ngSwitch]="currentEventTab()">
          <ng-container *ngSwitchCase="'upcoming'"
            >Vous n'avez aucun événement à venir</ng-container
          >
          <ng-container *ngSwitchCase="'past'"
            >Vous n'avez aucun événement passé</ng-container
          >
          <ng-container *ngSwitchCase="'pending'"
            >Vous n'avez aucune invitation en attente</ng-container
          >
        </p>
      </div>

      <!-- Event list -->
      <div
        *ngIf="!isLoadingEvents() && filteredEvents().length > 0"
        class="space-y-3"
      >
        <div
          *ngFor="let event of filteredEvents()"
          class="bg-white rounded-xl p-4 shadow-sm cursor-pointer hover:bg-gray-50 transition-colors"
          [attr.data-event-id]="event.id"
          (click)="navigateToEvent(event)"
          (keydown.enter)="navigateToEvent(event)"
          tabindex="0"
          role="button"
          [attr.aria-label]="'Voir les détails de l\'événement ' + event.title"
        >
          <div class="flex flex-col md:flex-row md:items-start gap-3">
            <!-- Date indicator -->
            <div
              class="flex-shrink-0 flex flex-col items-center justify-center rounded-lg bg-primary bg-opacity-10 p-2 w-16 h-16"
            >
              <span class="text-xs text-primary">{{
                formatEventDate(event.startDateTime, "month")
              }}</span>
              <span class="text-xl font-bold text-primary">{{
                formatEventDate(event.startDateTime, "day")
              }}</span>
              <span class="text-xs text-primary">{{
                formatEventDate(event.startDateTime, "time")
              }}</span>
            </div>

            <!-- Event details -->
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <h3 class="font-medium">{{ event.title }}</h3>
                <span
                  class="text-xs px-2 py-0.5 rounded-full"
                  [ngClass]="{
                    'bg-yellow-100 text-yellow-800': event.status === 'PENDING',
                    'bg-green-100 text-green-800': event.status === 'CONFIRMED',
                    'bg-red-100 text-red-800': event.status === 'CANCELLED'
                  }"
                >
                  {{ getStatusLabel(event.status) }}
                </span>
              </div>

              <p
                *ngIf="event.description"
                class="text-sm text-gray-600 mt-1 line-clamp-2"
              >
                {{ event.description }}
              </p>

              <div class="flex flex-wrap gap-y-1 mt-2">
                <div
                  *ngIf="event.location"
                  class="flex items-center text-xs text-gray-500 mr-3"
                >
                  <hlm-icon name="lucideMapPin" class="w-3 h-3 mr-1"></hlm-icon>
                  <span>{{ event.location }}</span>
                </div>
                <div class="flex items-center text-xs text-gray-500 mr-3">
                  <hlm-icon
                    name="lucideCalendar"
                    class="w-3 h-3 mr-1"
                  ></hlm-icon>
                  <span>{{
                    formatEventDate(event.startDateTime, "date")
                  }}</span>
                </div>
                <div class="flex items-center text-xs text-gray-500">
                  <hlm-icon name="lucideClock" class="w-3 h-3 mr-1"></hlm-icon>
                  <span>{{ formatEventDuration(event) }}</span>
                </div>
              </div>

              <!-- Invitation status for pending invitations -->
              <div
                *ngIf="currentEventTab() === 'pending'"
                class="mt-3 flex justify-end gap-2"
              >
                <button
                  (click)="respondToEventInvitation(event, 'DECLINED')"
                  class="py-1.5 px-4 rounded-full text-xs border border-red-500 text-red-500 hover:bg-red-50 transition-colors"
                  [disabled]="isProcessingEventResponse[event.id || '']"
                >
                  Refuser
                </button>
                <button
                  (click)="respondToEventInvitation(event, 'ACCEPTED')"
                  class="py-1.5 px-4 rounded-full text-xs bg-primary text-white hover:bg-primary-dark transition-colors"
                  [disabled]="isProcessingEventResponse[event.id || '']"
                >
                  Accepter
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Google Calendar (uniquement pour les admins) -->
  <div
    *ngIf="isAdmin()"
    class="bg-gray-sonar flex flex-col mx-10 md:w-3/5 rounded-3xl overflow-hidden"
  >
    <div class="flex justify-between px-5 py-4 border-b border-gray-200">
      <div class="flex items-center">
        <hlm-icon
          name="lucideCalendarClock"
          class="w-5 h-5 text-primary mr-2"
        ></hlm-icon>
        <p class="text-xl font-bold">Google Calendar</p>
      </div>
    </div>

    <div class="p-5">
      <!-- Statut de la liaison Google -->
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Liaison avec Google</h3>

        <!-- Affichage du statut de chargement -->
        <div *ngIf="isLoadingGoogleStatus()" class="flex items-center">
          <div
            class="animate-spin h-5 w-5 border-2 border-primary rounded-full border-t-transparent mr-2"
          ></div>
          <p class="text-sm">Vérification du statut...</p>
        </div>

        <!-- Affichage quand la liaison est établie -->
        <div
          *ngIf="!isLoadingGoogleStatus() && isGoogleLinked()"
          class="flex flex-col"
        >
          <div class="flex items-center mb-3">
            <div
              class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-medium flex items-center"
            >
              <svg
                class="w-3 h-3 mr-1"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M20 6L9 17L4 12"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Compte lié
            </div>
          </div>
          <div class="flex space-x-2 mt-2">
            <button
              (click)="loadGoogleCalendars()"
              class="py-1.5 px-4 rounded-full text-xs border border-primary text-primary hover:bg-primary-50 transition-colors flex items-center"
              [disabled]="isLoadingCalendars()"
            >
              <hlm-icon
                name="lucideCalendarClock"
                class="w-3 h-3 mr-1"
              ></hlm-icon>
              <span>Actualiser les calendriers</span>
            </button>
            <button
              (click)="unlinkGoogleAccount()"
              class="py-1.5 px-4 rounded-full text-xs border border-red-500 text-red-500 hover:bg-red-50 transition-colors"
              [disabled]="isGoogleLinking()"
            >
              <span>Délier le compte</span>
            </button>
          </div>
        </div>

        <!-- Affichage quand la liaison n'est pas établie -->
        <div
          *ngIf="!isLoadingGoogleStatus() && !isGoogleLinked()"
          class="flex flex-col"
        >
          <p class="text-sm mb-3">
            Liez votre compte Google pour accéder à vos calendriers
          </p>
          <button
            (click)="initiateGoogleLink()"
            class="flex items-center py-2 px-4 rounded-full text-sm bg-primary text-white hover:bg-primary-dark transition-colors w-fit shadow-sm"
            [disabled]="isGoogleLinking()"
          >
            <svg
              class="w-4 h-4 mr-2"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M21.8055 10.0415H21V10H12V14H17.6515C16.827 16.3285 14.6115 18 12 18C8.6865 18 6 15.3135 6 12C6 8.6865 8.6865 6 12 6C13.5295 6 14.921 6.577 15.9805 7.5195L18.809 4.691C17.023 3.0265 14.634 2 12 2C6.4775 2 2 6.4775 2 12C2 17.5225 6.4775 22 12 22C17.5225 22 22 17.5225 22 12C22 11.3295 21.931 10.675 21.8055 10.0415Z"
                fill="white"
              />
            </svg>
            <span *ngIf="!isGoogleLinking()">Lier mon compte Google</span>
            <div *ngIf="isGoogleLinking()" class="flex items-center">
              <div
                class="animate-spin h-4 w-4 border-2 border-white rounded-full border-t-transparent mr-2"
              ></div>
              <span>Liaison en cours...</span>
            </div>
          </button>

          <!-- Affichage des erreurs -->
          <div
            *ngIf="googleLinkError()"
            class="mt-3 p-3 bg-red-100 text-red-800 rounded-md text-sm"
          >
            {{ googleLinkError() }}
          </div>
        </div>
      </div>

      <!-- Affichage des calendriers et création -->
      <div
        *ngIf="isGoogleLinked() && googleCalendars().length > 0"
        class="mt-6"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Mes calendriers</h3>
          <div class="flex space-x-2">
            <button
              (click)="createNewCalendar()"
              class="py-1.5 px-4 rounded-full text-xs bg-primary text-white hover:bg-primary-dark transition-colors flex items-center shadow-sm"
            >
              <svg
                class="w-3 h-3 mr-1"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 5V19M5 12H19"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Nouveau calendrier</span>
            </button>
            <button
              (click)="showEventCreationForm = true"
              class="py-1.5 px-4 rounded-full text-xs bg-green-600 text-white hover:bg-green-700 transition-colors flex items-center shadow-sm"
            >
              <svg
                class="w-3 h-3 mr-1"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 5V19M5 12H19"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Nouvel événement</span>
            </button>
          </div>
        </div>

        <!-- Formulaire de création d'événement -->
        <div
          *ngIf="showEventCreationForm"
          class="mb-6 bg-white p-5 rounded-lg border border-gray-200 shadow-md"
        >
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-medium flex items-center">
              <hlm-icon
                name="lucideCalendarClock"
                class="w-4 h-4 mr-2 text-primary"
              ></hlm-icon>
              Créer un nouvel événement
            </h3>
            <button
              (click)="showEventCreationForm = false"
              class="text-gray-400 hover:text-gray-600"
              aria-label="Fermer le formulaire"
            >
              <svg
                class="w-5 h-5"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M18 6L6 18M6 6L18 18"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>

          <form
            [formGroup]="eventForm"
            (ngSubmit)="createEvent()"
            class="space-y-4"
          >
            <!-- Champ du titre -->
            <div>
              <label
                for="event-title"
                class="block text-sm font-medium mb-1 text-gray-700"
              >
                Titre de l'événement *
              </label>
              <input
                id="event-title"
                type="text"
                formControlName="title"
                class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent"
                placeholder="Ajouter un titre"
              />
              <div
                *ngIf="eventForm.get('title')?.errors?.['required'] && eventForm.get('title')?.touched"
                class="text-xs text-red-500 mt-1"
              >
                Le titre est requis
              </div>
            </div>

            <!-- Sélection du calendrier -->
            <div>
              <label
                for="event-calendar"
                class="block text-sm font-medium mb-1 text-gray-700"
              >
                Calendrier *
              </label>
              <div class="relative">
                <select
                  id="event-calendar"
                  formControlName="calendarId"
                  class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent appearance-none pr-10"
                >
                  <option [ngValue]="null" disabled>
                    Choisir un calendrier
                  </option>
                  <option
                    *ngFor="let calendar of googleCalendars()"
                    [value]="calendar.id"
                  >
                    {{ calendar.summary }}
                    {{ calendar.primary ? "(principal)" : "" }}
                  </option>
                </select>
                <div
                  class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-500"
                >
                  <svg
                    class="w-4 h-4"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M6 9L12 15L18 9"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
              </div>
              <div
                *ngIf="eventForm.get('calendarId')?.errors?.['required'] && eventForm.get('calendarId')?.touched"
                class="text-xs text-red-500 mt-1"
              >
                Veuillez sélectionner un calendrier
              </div>
            </div>

            <!-- Dates et heures -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label
                  for="event-start"
                  class="block text-sm font-medium mb-1 text-gray-700"
                >
                  Date et heure de début *
                </label>
                <input
                  id="event-start"
                  type="datetime-local"
                  formControlName="startDateTime"
                  class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent"
                />
                <div
                  *ngIf="eventForm.get('startDateTime')?.errors?.['required'] && eventForm.get('startDateTime')?.touched"
                  class="text-xs text-red-500 mt-1"
                >
                  La date de début est requise
                </div>
              </div>
              <div>
                <label
                  for="event-end"
                  class="block text-sm font-medium mb-1 text-gray-700"
                >
                  Date et heure de fin *
                </label>
                <input
                  id="event-end"
                  type="datetime-local"
                  formControlName="endDateTime"
                  class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent"
                />
                <div
                  *ngIf="eventForm.get('endDateTime')?.errors?.['required'] && eventForm.get('endDateTime')?.touched"
                  class="text-xs text-red-500 mt-1"
                >
                  La date de fin est requise
                </div>
                <div
                  *ngIf="eventForm.errors?.['endDateBeforeStart']"
                  class="text-xs text-red-500 mt-1"
                >
                  La date de fin doit être postérieure à la date de début
                </div>
              </div>
            </div>

            <!-- Champ du lieu avec recherche Nominatim -->
            <div>
              <label
                for="event-location"
                class="block text-sm font-medium mb-1 text-gray-700"
              >
                Lieu
              </label>
              <div class="relative">
                <input
                  id="event-location"
                  type="text"
                  formControlName="location"
                  class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="Rechercher une adresse..."
                  (input)="searchLocation($any($event.target).value)"
                  (focus)="
                    showLocationResults.set(locationSearchResults().length > 0)
                  "
                  (blur)="hideLocationResults()"
                />
                <div
                  class="absolute right-2 top-1/2 transform -translate-y-1/2"
                >
                  <div
                    *ngIf="isSearchingLocation()"
                    class="animate-spin h-4 w-4 border-2 border-primary rounded-full border-t-transparent"
                  ></div>
                  <svg
                    *ngIf="!isSearchingLocation()"
                    class="h-4 w-4 text-gray-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
                <!-- Résultats de recherche -->
                <div
                  *ngIf="
                    showLocationResults() && locationSearchResults().length > 0
                  "
                  class="absolute left-0 right-0 mt-1 max-h-60 overflow-y-auto bg-white shadow-lg border border-gray-300 rounded-md z-10"
                >
                  <ul class="py-1" role="listbox">
                    <li
                      *ngFor="
                        let result of locationSearchResults();
                        let i = index
                      "
                      class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm"
                      (click)="selectLocation(result)"
                      (keydown.enter)="selectLocation(result)"
                      tabindex="0"
                      role="option"
                      [attr.aria-selected]="false"
                      [attr.aria-label]="'Sélectionner ' + result.display_name"
                      [id]="'location-result-' + i"
                    >
                      <div class="font-medium">{{ result.display_name }}</div>
                      <div class="text-xs text-gray-500 truncate">
                        {{ result.address?.road ?? "" }}
                        {{
                          result.address && result.address.house_number
                            ? ", " + result.address.house_number
                            : ""
                        }}
                        {{
                          result.address && result.address.postcode
                            ? ", " + result.address.postcode
                            : ""
                        }}
                        {{
                          result.address && result.address.city
                            ? " " + result.address.city
                            : ""
                        }}
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              <!-- Champs cachés pour les coordonnées -->
              <input type="hidden" formControlName="latitude" />
              <input type="hidden" formControlName="longitude" />
            </div>

            <!-- Description -->
            <div>
              <label
                for="event-description"
                class="block text-sm font-medium mb-1 text-gray-700"
              >
                Description
              </label>
              <textarea
                id="event-description"
                formControlName="description"
                rows="4"
                class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                placeholder="Ajouter une description"
              ></textarea>
            </div>

            <!-- Participants (emails) -->
            <div>
              <label
                for="event-attendees"
                class="block text-sm font-medium mb-1 text-gray-700"
              >
                Participants (emails séparés par des virgules)
              </label>
              <input
                id="event-attendees"
                type="text"
                formControlName="attendees"
                class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent"
                placeholder="email1@exemple.com, email2@exemple.com"
              />
              <div
                *ngIf="eventForm.get('attendees')?.errors?.['pattern']"
                class="text-xs text-red-500 mt-1"
              >
                Format d'emails invalide
              </div>
            </div>

            <!-- Couleur de l'événement -->
            <div>
              <label
                for="event-color"
                class="block text-sm font-medium mb-2 text-gray-700"
              >
                Couleur de l'événement
              </label>
              <div id="event-color" class="flex flex-wrap gap-2">
                <button
                  *ngFor="let colorId of getColorIds()"
                  type="button"
                  [style.background-color]="getEventColor(colorId)"
                  class="w-6 h-6 rounded-full cursor-pointer hover:ring-2 hover:ring-offset-2 hover:ring-gray-400"
                  [class.ring-2]="eventForm.get('colorId')?.value === colorId"
                  [class.ring-offset-2]="
                    eventForm.get('colorId')?.value === colorId
                  "
                  [class.ring-primary]="
                    eventForm.get('colorId')?.value === colorId
                  "
                  (click)="eventForm.get('colorId')?.setValue(colorId)"
                  [attr.aria-label]="'Sélectionner la couleur ' + colorId"
                ></button>
              </div>
            </div>

            <!-- Boutons d'actions -->
            <div
              class="flex justify-end space-x-3 pt-3 border-t border-gray-100"
            >
              <button
                type="button"
                (click)="showEventCreationForm = false"
                class="py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors"
              >
                Annuler
              </button>
              <button
                type="submit"
                class="py-2 px-4 rounded-md bg-primary text-white hover:bg-primary-dark transition-colors flex items-center"
                [disabled]="eventForm.invalid || isCreatingEvent"
              >
                <div
                  *ngIf="isCreatingEvent"
                  class="animate-spin h-4 w-4 border-2 border-white rounded-full border-t-transparent mr-2"
                ></div>
                <span>Créer l'événement</span>
              </button>
            </div>
          </form>
        </div>

        <!-- Sélecteur de calendrier amélioré -->
        <div *ngIf="!isLoadingCalendars()" class="mb-6">
          <label for="calendar-select" class="block text-sm font-medium mb-2"
            >Sélectionner un calendrier :</label
          >
          <div class="flex gap-3">
            <div class="relative w-full md:w-2/3">
              <select
                #calendarSelect
                id="calendar-select"
                [value]="selectedCalendarId() || ''"
                (change)="loadCalendarEvents(calendarSelect.value)"
                class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent appearance-none pr-10"
              >
                <option value="" disabled>Choisir un calendrier</option>
                <option
                  *ngFor="let calendar of googleCalendars()"
                  [value]="calendar.id"
                >
                  {{ calendar.summary }}
                  {{ calendar.primary ? "(principal)" : "" }}
                </option>
              </select>
              <div
                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-500"
              >
                <svg
                  class="w-4 h-4"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M6 9L12 15L18 9"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </div>
            </div>

            <button
              (click)="loadGoogleCalendars()"
              class="px-4 rounded-md border border-primary text-primary hover:bg-primary-50 transition-colors shadow-sm"
              [disabled]="isLoadingCalendars()"
            >
              <div class="flex items-center">
                <div
                  *ngIf="isLoadingCalendars()"
                  class="animate-spin h-4 w-4 border-2 border-primary rounded-full border-t-transparent mr-2"
                ></div>
                <span>Actualiser</span>
              </div>
            </button>
          </div>
        </div>

        <!-- Filtres pour les événements -->
        <div
          *ngIf="selectedCalendarId() && !isLoadingEvents()"
          class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200"
        >
          <h4 class="text-sm font-medium mb-3 text-gray-600">
            Filtres des événements
          </h4>
          <div class="flex flex-col md:flex-row gap-3">
            <div class="w-full md:w-1/2">
              <label
                for="event-filter"
                class="block text-xs font-medium mb-1 text-gray-600"
                >Période :</label
              >
              <div class="relative">
                <select
                  id="event-filter"
                  [(ngModel)]="eventTimeFilter"
                  (change)="filterCalendarEvents()"
                  class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent appearance-none pr-10 text-sm"
                >
                  <option value="upcoming">Événements à venir</option>
                  <option value="past">Événements passés</option>
                  <option value="all">Tous les événements</option>
                  <option value="today">Aujourd'hui</option>
                  <option value="week">Cette semaine</option>
                  <option value="month">Ce mois</option>
                </select>
                <div
                  class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-500"
                >
                  <svg
                    class="w-4 h-4"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M6 9L12 15L18 9"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
              </div>
            </div>

            <div class="w-full md:w-1/2">
              <label
                for="event-search"
                class="block text-xs font-medium mb-1 text-gray-600"
                >Recherche :</label
              >
              <div class="relative">
                <input
                  id="event-search"
                  type="text"
                  [(ngModel)]="eventSearchQuery"
                  (input)="filterCalendarEvents()"
                  placeholder="Rechercher un événement..."
                  class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent pl-10 text-sm"
                />
                <div
                  class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-500"
                >
                  <svg
                    class="w-4 h-4"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Affichage des événements filtrés -->
        <div
          *ngIf="selectedCalendarId() && filteredCalendarEvents().length > 0"
          class="mt-6"
        >
          <h3 class="text-lg font-medium mb-4 flex items-center">
            <hlm-icon
              name="lucideCalendar"
              class="w-4 h-4 mr-2 text-primary"
            ></hlm-icon>
            Événements {{ getEventFilterLabel() }}
            <span class="text-sm font-normal text-gray-500 ml-2">
              ({{ filteredCalendarEvents().length }} événement{{
                filteredCalendarEvents().length > 1 ? "s" : ""
              }})
            </span>
          </h3>

          <!-- Liste des événements -->
          <div *ngIf="!isLoadingEvents()" class="space-y-3">
            <div
              *ngFor="let event of filteredCalendarEvents()"
              class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow border-l-4"
              [style.border-color]="getEventColor(event.colorId)"
            >
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <h4 class="font-medium">{{ event.summary }}</h4>
                  <p
                    *ngIf="event.description"
                    class="text-sm text-gray-600 mt-1 line-clamp-2"
                  >
                    {{ event.description }}
                  </p>
                </div>
                <div class="flex items-center gap-2">
                  <span
                    *ngIf="event.status"
                    class="text-xs px-2 py-0.5 rounded-full ml-2 flex-shrink-0"
                    [ngClass]="{
                      'bg-green-100 text-green-800':
                        event.status === 'confirmed',
                      'bg-red-100 text-red-800': event.status === 'cancelled',
                      'bg-yellow-100 text-yellow-800':
                        event.status === 'tentative'
                    }"
                  >
                    {{ getEventStatusLabel(event.status) }}
                  </span>
                  <button
                    *ngIf="event.status !== 'cancelled'"
                    (click)="editEvent(event, selectedCalendarId() || '')"
                    class="p-1 text-blue-600 hover:bg-blue-50 rounded-full"
                    [attr.aria-label]="'Modifier l\'événement ' + event.summary"
                  >
                    <svg
                      class="w-4 h-4"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M18.5 2.5C18.8978 2.10217 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10217 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10217 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>
                </div>
              </div>

              <div class="flex flex-wrap gap-y-2 mt-3 text-xs">
                <div
                  *ngIf="event.location"
                  class="flex items-center text-gray-500 mr-4 bg-gray-50 px-2 py-1 rounded"
                >
                  <hlm-icon name="lucideMapPin" class="w-3 h-3 mr-1"></hlm-icon>
                  <span>{{ event.location }}</span>
                </div>
                <div
                  class="flex items-center text-gray-500 mr-4 bg-gray-50 px-2 py-1 rounded"
                >
                  <hlm-icon
                    name="lucideCalendar"
                    class="w-3 h-3 mr-1"
                  ></hlm-icon>
                  <span>{{
                    formatGoogleEventDate(
                      event.start.dateTime || event.start.date || ""
                    )
                  }}</span>
                </div>
              </div>

              <div
                *ngIf="event.attendees && event.attendees.length > 0"
                class="mt-3 pt-2 border-t border-gray-100"
              >
                <p class="text-xs text-gray-500 mb-1">Participants :</p>
                <div class="flex flex-wrap gap-1 mt-1">
                  <div
                    *ngFor="let attendee of event.attendees.slice(0, 3)"
                    class="text-xs px-2 py-1 rounded-full flex items-center"
                    [ngClass]="{
                      'bg-green-50 text-green-700':
                        attendee.responseStatus === 'accepted',
                      'bg-yellow-50 text-yellow-700':
                        attendee.responseStatus === 'tentative',
                      'bg-red-50 text-red-700':
                        attendee.responseStatus === 'declined',
                      'bg-gray-50 text-gray-700':
                        !attendee.responseStatus ||
                        attendee.responseStatus === 'needsAction'
                    }"
                  >
                    <div
                      class="w-2 h-2 rounded-full mr-1"
                      [ngClass]="{
                        'bg-green-500': attendee.responseStatus === 'accepted',
                        'bg-yellow-500':
                          attendee.responseStatus === 'tentative',
                        'bg-red-500': attendee.responseStatus === 'declined',
                        'bg-gray-400':
                          !attendee.responseStatus ||
                          attendee.responseStatus === 'needsAction'
                      }"
                    ></div>
                    {{ attendee.displayName || attendee.email }}
                  </div>
                  <div
                    *ngIf="event.attendees.length > 3"
                    class="text-xs px-2 py-1 rounded-full bg-gray-100"
                  >
                    +{{ event.attendees.length - 3 }} plus
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Aucun événement -->
        <div
          *ngIf="
            selectedCalendarId() &&
            !isLoadingEvents() &&
            filteredCalendarEvents().length === 0
          "
          class="mt-6 py-8 flex flex-col items-center justify-center bg-gray-50 rounded-lg border border-gray-200"
        >
          <hlm-icon
            name="lucideCalendarX"
            class="w-12 h-12 text-gray-400 mb-3"
          ></hlm-icon>
          <p class="text-sm text-gray-500 font-medium">
            Aucun événement trouvé
          </p>
          <p
            *ngIf="eventSearchQuery || eventTimeFilter !== 'all'"
            class="text-xs text-gray-400 mt-1"
          >
            Essayez de modifier vos filtres
          </p>
        </div>

        <!-- Chargement des événements -->
        <div *ngIf="isLoadingEvents()" class="flex justify-center py-8">
          <div
            class="animate-spin w-8 h-8 border-3 border-primary border-t-transparent rounded-full"
          ></div>
        </div>
      </div>
    </div>
  </div>
</div>
