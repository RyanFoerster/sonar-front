<div class="flex flex-col justify-center gap-5">
  <div
    class="background-div h-40 max-w-full md:h-60 relative mx-10 overflow-hidden rounded-3xl shadow"
  >
    <div
      class="flex justify-center items-center py-6 px-2 md:flex md:w-3/5 md:py-10 md:pl-10"
    >
      <div class="flex justify-center items-center">
        <div
          class="size-28 md:size-40 rounded-full bg-gray-sonar flex justify-center items-center"
        >
          <p
            class="text-white text-6xl bg-primary rounded-full size-24 md:size-36 flex justify-center items-center"
          >
            {{
              connectedUser()?.firstName?.slice(0, 1) ||
                connectedUser()?.name?.slice(0, 1)
            }}
          </p>
        </div>
      </div>

      <div class="flex flex-col mx-2 w-1/2">
        <p class="flex text-[8px] md:text-sm text-white font-light">
          {{ connectedUser()?.comptePrincipal?.username }}
        </p>
        <p class="flex text-lg leading-none md:text-3xl text-white font-bold">
          {{ connectedUser()?.firstName }}
        </p>
        <p class="flex text-lg leading-none md:text-3xl text-white font-bold">
          {{ connectedUser()?.name }}
        </p>
        <p class="flex text-[8px] md:text-lg text-white font-light">
          {{ connectedUser()?.email }}
        </p>
      </div>
    </div>

    <div
      class="absolute bottom-2 right-2 size-5 bg-white rounded-full flex justify-center items-center"
    >
      <hlm-icon class="w-3" name="lucideEdit" />
    </div>
  </div>

  <div
    class="bg-gray-sonar flex flex-col-reverse md:flex-col mx-10 md:w-3/5 rounded-3xl"
  >
    <div class="flex justify-between md:pt-5 px-5">
      <p class="text-xl font-bold hidden md:block">Informations</p>
      <div class="flex flex-col md:px-0 md:pb-0 justify-center w-full md:w-fit">
        <hlm-dialog class="flex pb-2 justify-start w-full">
          <button
            class="rounded-full text-xs w-auto hidden md:flex md:text-base justify-end"
            id="edit-profile"
            brnDialogTrigger
            hlmBtn
          >
            Modifier le profil
          </button>
          <hlm-dialog-content
            class="p-5 rounded-xl m-4 w-11/12"
            *brnDialogContent="let ctx"
          >
            <hlm-dialog-header>
              <h3 hlmDialogTitle>Modifier le profil</h3>
              <p class="text-xs md:text-base" hlmDialogDescription>
                Apportez des modifications à votre profil ici. Cliquez sur
                "Enregistrer" lorsque vous avez terminé.
              </p>
            </hlm-dialog-header>
            <form
              [formGroup]="updateUserForm"
              class="py-1 grid gap-1 md:py-4 md:gap-4"
              (ngSubmit)="updateUser(ctx)"
            >
              <div
                class="items-center grid grid-cols-4 gap-4 *:text-xs *:md:text-base"
              >
                <label hlmLabel for="username" class="text-left font-bold"
                  >Username</label
                >
                <input
                  formControlName="username"
                  hlmInput
                  id="username"
                  [value]="connectedUser()?.comptePrincipal?.username"
                  class="col-span-3 m-2 shadow-lg border rounded-full px-2"
                />
              </div>

              <div
                class="items-center grid grid-cols-4 gap-4 *:text-xs *:md:text-base"
              >
                <label hlmLabel for="lastname" class="text-left font-bold"
                  >Nom</label
                >
                <input
                  formControlName="name"
                  hlmInput
                  id="lastname"
                  [value]="connectedUser()?.name"
                  class="col-span-3 m-2 shadow-lg border rounded-full px-2"
                />
              </div>

              <div
                class="items-center grid grid-cols-4 gap-4 *:text-xs *:md:text-base"
              >
                <label hlmLabel for="firstname" class="text-left font-bold"
                  >Prénom</label
                >
                <input
                  formControlName="firstName"
                  hlmInput
                  id="firstname"
                  [value]="connectedUser()?.firstName"
                  class="col-span-3 m-2 shadow-lg border rounded-full px-2"
                />
              </div>

              <div
                class="items-center grid grid-cols-4 gap-4 *:text-xs *:md:text-base"
              >
                <label hlmLabel for="number" class="text-left font-bold"
                  >Numéro national</label
                >
                <input
                  formControlName="numeroNational"
                  hlmInput
                  id="number"
                  [value]="connectedUser()?.numeroNational"
                  class="col-span-3 m-2 shadow-lg border rounded-full px-2"
                />
              </div>

              <div
                class="items-center grid grid-cols-4 gap-4 *:text-xs *:md:text-base"
              >
                <label hlmLabel for="phone" class="text-left font-bold"
                  >Téléphone</label
                >
                <input
                  formControlName="telephone"
                  hlmInput
                  id="phone"
                  [value]="connectedUser()?.telephone"
                  class="col-span-3 m-2 shadow-lg border rounded-full px-2"
                />
              </div>

              <div
                class="items-center grid grid-cols-4 gap-4 *:text-xs *:md:text-base"
              >
                <label hlmLabel for="email" class="text-left font-bold"
                  >E-mail</label
                >
                <input
                  formControlName="email"
                  hlmInput
                  id="email"
                  [value]="connectedUser()?.email"
                  class="col-span-3 m-2 shadow-lg border rounded-full px-2"
                />
              </div>

              <div
                class="items-center grid grid-cols-4 gap-4 *:text-xs *:md:text-base"
              >
                <label hlmLabel for="number" class="text-left font-bold"
                  >Compte bancaire</label
                >
                <input
                  formControlName="iban"
                  hlmInput
                  id="number"
                  [value]="connectedUser()?.iban"
                  class="col-span-3 m-2 shadow-lg border rounded-full px-2"
                />
              </div>

              <div
                class="items-center grid grid-cols-4 gap-4 *:text-xs *:md:text-base"
              >
                <label hlmLabel for="address" class="text-left font-bold"
                  >Adresse</label
                >
                <input
                  formControlName="address"
                  hlmInput
                  id="address"
                  [value]="connectedUser()?.address"
                  class="col-span-3 m-2 shadow-lg border rounded-full px-2"
                />
              </div>
              <button
                class="rounded-full text-xs md:text-base"
                hlmBtn
                type="submit"
              >
                Enregistrer
              </button>
            </form>
          </hlm-dialog-content>
          <button
            class="rounded-full text-xs w-full flex md:hidden md:text-base"
            id="edit-profile"
            brnDialogTrigger
            hlmBtn
          >
            Modifier le profil
          </button>
        </hlm-dialog>
      </div>
    </div>

    <div class="p-5 flex flex-col gap-2">
      <div class="flex">
        <p class="font-bold text-[9px] md:text-sm w-28 md:w-56">Adresse</p>
        @if (!connectedUser()?.address) {
        <p class="text-[9px] md:text-sm text-red-500">
          Aucune adresse enregistrer cliquer sur le bouton modifier le profil
          afin d'en définir une
        </p>
        }
        <p class="text-[9px] md:text-sm">{{ connectedUser()?.address }}</p>
      </div>

      <!-- Section Notifications -->
      <div class="flex items-center mt-4 mb-2">
        <p class="font-bold text-[9px] md:text-sm w-28 md:w-56">
          Notifications
        </p>
        @if (notificationsSupported()) {
        <div class="flex items-center gap-2">
          <!-- Switch personnalisé sans bouton -->
          <div
            class="custom-switch cursor-pointer"
            (click)="toggleNotifications(!notificationsEnabled())"
            (keydown.enter)="toggleNotifications(!notificationsEnabled())"
            tabindex="0"
            role="switch"
            [attr.aria-checked]="notificationsEnabled()"
            [attr.aria-label]="
              notificationsEnabled()
                ? 'Désactiver les notifications'
                : 'Activer les notifications'
            "
            [class.is-processing]="isProcessingNotificationPermission()"
          >
            <div
              class="switch-track"
              [ngClass]="{
                'switch-track-active': notificationsEnabled(),
                'switch-track-inactive': !notificationsEnabled(),
                'opacity-50': isProcessingNotificationPermission()
              }"
            >
              <div
                class="switch-thumb relative"
                [ngClass]="{
                  'switch-thumb-active': notificationsEnabled(),
                  'switch-thumb-inactive': !notificationsEnabled()
                }"
              >
                <!-- Indicateur de chargement -->
                @if (isProcessingNotificationPermission()) {
                <div
                  class="h-3 w-3 absolute top-0 bottom-0 left-0 right-0 m-auto"
                >
                  <div
                    class="animate-spin h-3 w-3 border-2 border-primary rounded-full border-t-transparent"
                  ></div>
                </div>
                }
              </div>
            </div>
          </div>

          <div class="flex items-center">
            @if (notificationsEnabled()) {
            <hlm-icon
              name="lucideBell"
              class="text-green-600 w-4 h-4 md:w-5 md:h-5"
            ></hlm-icon>
            <span class="text-[9px] md:text-sm text-green-600 ml-1"
              >Activées</span
            >
            } @else {
            <hlm-icon
              name="lucideBellOff"
              class="text-red-600 w-4 h-4 md:w-5 md:h-5"
            ></hlm-icon>
            <span class="text-[9px] md:text-sm text-red-600 ml-1"
              >Désactivées</span
            >
            }
          </div>
        </div>
        } @else {
        <p class="text-[9px] md:text-sm text-red-500">
          Les notifications ne sont pas supportées par votre navigateur
        </p>
        }
      </div>

      <div class="flex">
        <p class="font-bold text-[9px] md:text-sm w-28 md:w-56">
          Numéro de téléphone
        </p>
        <p class="text-[9px] md:text-sm">{{ connectedUser()?.telephone }}</p>
      </div>

      <div class="flex">
        <p class="font-bold text-[9px] md:text-sm w-28 md:w-56">
          Numéro national
        </p>
        <p class="text-[9px] md:text-sm">
          {{ connectedUser()?.numeroNational }}
        </p>
      </div>

      <div class="flex">
        <p class="font-bold text-[9px] md:text-sm w-28 md:w-56">
          Compte bancaire
        </p>
        <p class="text-[9px] md:text-sm">{{ connectedUser()?.iban }}</p>
      </div>
    </div>
  </div>

  <!-- Nouvelle section pour les invitations de groupe -->
  <div
    class="bg-gray-sonar flex flex-col mx-10 md:w-3/5 rounded-3xl overflow-hidden"
  >
    <div class="flex justify-between px-5 py-4 border-b border-gray-200">
      <div class="flex items-center">
        <hlm-icon
          name="lucideUsers"
          class="w-5 h-5 text-primary mr-2"
        ></hlm-icon>
        <p class="text-xl font-bold">Invitations de groupe</p>
      </div>
      <div *ngIf="pendingInvitations().length > 0" class="flex items-center">
        <span class="bg-primary text-white rounded-full px-2 py-0.5 text-xs">
          {{ pendingInvitations().length }}
        </span>
      </div>
    </div>

    <div class="p-2 md:p-4">
      <!-- Loading state -->
      <div *ngIf="isLoadingInvitations()" class="flex justify-center py-6">
        <div
          class="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full"
        ></div>
      </div>

      <!-- No invitations state -->
      <div
        *ngIf="!isLoadingInvitations() && pendingInvitations().length === 0"
        class="flex flex-col items-center justify-center py-8 text-center"
      >
        <hlm-icon
          name="lucideInbox"
          class="w-12 h-12 text-gray-400 mb-3"
        ></hlm-icon>
        <p class="text-sm text-gray-500">
          Vous n'avez aucune invitation de groupe en attente
        </p>
      </div>

      <!-- List of invitations -->
      <div
        *ngIf="!isLoadingInvitations() && pendingInvitations().length > 0"
        class="space-y-3"
      >
        <div
          *ngFor="let invitation of pendingInvitations()"
          class="bg-white rounded-xl p-4 shadow-sm"
        >
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center mb-1">
                <div
                  class="w-10 h-10 rounded-full flex items-center justify-center bg-primary text-white font-bold text-sm mr-3"
                >
                  {{
                    invitation.group.username
                      ? invitation.group.username.substring(0, 2).toUpperCase()
                      : "GP"
                  }}
                </div>
                <div>
                  <h3 class="font-medium">
                    {{ invitation.group.username || "Groupe" }}
                  </h3>
                  <p class="text-xs text-gray-500">
                    Invitation reçue {{ getRelativeTime(invitation.createdAt) }}
                  </p>
                </div>
              </div>
              <p
                *ngIf="invitation.message"
                class="text-sm text-gray-600 mt-2 ml-13 italic"
              >
                "{{ invitation.message }}"
              </p>
            </div>
          </div>
          <div class="flex justify-end gap-2 mt-3">
            <button
              (click)="respondToInvitation(invitation.id, false)"
              class="py-1.5 px-4 rounded-full text-xs border border-red-500 text-red-500 hover:bg-red-50 transition-colors relative"
              [disabled]="isProcessingInvitation(invitation.id)"
            >
              <span [class.opacity-0]="isProcessingInvitation(invitation.id)"
                >Refuser</span
              >
              <div
                *ngIf="isProcessingInvitation(invitation.id)"
                class="absolute inset-0 flex items-center justify-center"
              >
                <div
                  class="animate-spin h-3 w-3 border-2 border-red-500 rounded-full border-t-transparent"
                ></div>
              </div>
            </button>
            <button
              (click)="respondToInvitation(invitation.id, true)"
              class="py-1.5 px-4 rounded-full text-xs bg-primary text-white hover:bg-primary-dark transition-colors relative"
              [disabled]="isProcessingInvitation(invitation.id)"
            >
              <span [class.opacity-0]="isProcessingInvitation(invitation.id)"
                >Accepter</span
              >
              <div
                *ngIf="isProcessingInvitation(invitation.id)"
                class="absolute inset-0 flex items-center justify-center"
              >
                <div
                  class="animate-spin h-3 w-3 border-2 border-white rounded-full border-t-transparent"
                ></div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
